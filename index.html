<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal Wi-Fi</title>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body {display:flex; justify-content:center; align-items:center; height:100vh; background:linear-gradient(135deg,#2575fc,#6a11cb); color:#fff; text-align:center;}
.container {background: rgba(255,255,255,0.08); padding:40px 30px; border-radius:18px; backdrop-filter:blur(8px); box-shadow:0 8px 32px rgba(0,0,0,0.25); width:100%; max-width:420px;}
h1 {font-size:1.8rem; margin-bottom:20px;}
input[type="text"], input[type="email"] {width:100%; padding:12px 16px; margin-bottom:12px; border-radius:999px; border:none; outline:none; font-size:0.95rem;}
.btn-entrar {width:100%; padding:12px; font-size:1.05rem; font-weight:700; color:#2575fc; background:#fff; border:none; border-radius:999px; cursor:pointer;}
.btn-entrar:hover {transform:translateY(-3px); box-shadow:0 6px 18px rgba(0,0,0,0.18);}
.error {color:#ffb4b4; margin-top:10px; display:none; font-weight:600;}
.small {font-size:0.85rem; opacity:0.9; margin-top:12px;}
.valid {color:#00ff88; display:block; margin-top:6px;}
.invalid {color:#ff4c4c; display:block; margin-top:6px;}
</style>
</head>
<body>
<div class="container">
    <h1>Portal Wi-Fi</h1>
    <div class="error" id="error-msg"></div>

    <input type="text" id="cpf" placeholder="Digite seu CPF" maxlength="14" autocomplete="off" />
    <input type="text" id="nome" placeholder="Digite seu nome completo" autocomplete="name" />
    <input type="email" id="email" placeholder="Digite seu e-mail (opcional)" autocomplete="email" />

    <span id="cpfFeedback"></span>
    <button class="btn-entrar" id="btnEntrar" disabled>Continuar</button>

    <div class="small">Ao prosseguir seu CPF será registrado e você terá acesso à internet.</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  databaseURL: "SEU_DATABASE_URL",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_STORAGE_BUCKET",
  messagingSenderId: "SEU_MESSAGING_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.getElementById('cpf');
    const feedback = document.getElementById('cpfFeedback');
    const submitBtn = document.getElementById('btnEntrar');
    const errorMsg = document.getElementById('error-msg');

    function formatCPF(value) {
        value = value.replace(/\D/g, '');
        if (value.length > 3) value = value.replace(/^(\d{3})(\d)/, '$1.$2');
        if (value.length > 6) value = value.replace(/^(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
        if (value.length > 9) value = value.replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
        return value;
    }

    function validarCPF(cpfRaw){
        const cpf = (cpfRaw||'').replace(/\D/g,'');
        if(cpf.length !== 11) return false;
        if(/^(\d)\1{10}$/.test(cpf)) return false;
        let soma = 0;
        for(let i=0;i<9;i++) soma += parseInt(cpf.charAt(i))*(10-i);
        let resto = 11 - (soma % 11); if(resto === 10 || resto === 11) resto = 0;
        if(resto !== parseInt(cpf.charAt(9))) return false;
        soma = 0;
        for(let i=0;i<10;i++) soma += parseInt(cpf.charAt(i))*(11-i);
        resto = 11 - (soma % 11); if(resto === 10 || resto === 11) resto = 0;
        if(resto !== parseInt(cpf.charAt(10))) return false;
        return true;
    }

    cpfInput.addEventListener('input', function(){
        this.value = formatCPF(this.value);
        if(validarCPF(this.value)){
            feedback.textContent = 'CPF válido';
            feedback.className = 'valid';
            submitBtn.disabled = false;
        } else {
            feedback.textContent = 'CPF inválido';
            feedback.className = 'invalid';
            submitBtn.disabled = true;
        }
    });

    submitBtn.addEventListener('click', async function(){
        const cpfMasked = cpfInput.value.trim();
        const nome = document.getElementById('nome').value.trim();
        const email = document.getElementById('email').value.trim();
        errorMsg.style.display = 'none';

        if(!validarCPF(cpfMasked)){
            errorMsg.textContent = 'CPF inválido!';
            errorMsg.style.display = 'block';
            return;
        }

        const cpf = cpfMasked.replace(/\D/g,'');

        // Gera senha dinâmica
        const senha = Math.random().toString(36).slice(-8);

        // Salva no Firebase
        try {
            const agora = new Date();
            const dataHora = agora.toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" });
            await set(ref(db, 'usuarios/' + cpf), {
                nome: nome || '',
                email: email || '',
                timestamp: Date.now(),
                dataHora: dataHora,
                senha: senha
            });
        } catch(err){
            console.error('Erro ao salvar:', err);
            errorMsg.textContent = 'Erro ao salvar dados.';
            errorMsg.style.display = 'block';
            return;
        }

        // Redireciona (teste com HTTPS para GitHub Pages)
        const redirectUrl = encodeURIComponent(localStorage.getItem('wifi_redirect') || 'https://www.google.com');
        const routerLoginUrl = `http://192.168.15.9/login?username=${cpf}&password=${senha}&redirect=${redirectUrl}`;

        // Para teste no GitHub Pages, use primeiro Google
        // window.location.href = 'https://www.google.com';
        window.location.href = routerLoginUrl;
    });

    // Captura URL original
    window.addEventListener('load', function() {
        localStorage.setItem('wifi_redirect', window.location.href);
    });
});
</script>
</body>
</html>