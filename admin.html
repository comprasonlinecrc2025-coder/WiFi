<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Admin - Wi-Fi</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    padding: 20px;
}
h1 {color:#333; text-align:center;}
#loginBox, #painel {max-width:900px; margin:40px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2);}
input[type="password"] {padding:10px; width:100%; margin:10px 0; border:1px solid #ccc; border-radius:6px;}
button {padding:10px 15px; border:none; background:#2575fc; color:#fff; cursor:pointer; border-radius:6px; transition:0.3s;}
button:hover {background:#6a11cb;}
#error {color:red; margin-top:10px; text-align:center;}

/* Dashboard cards */
.cards {display:flex; justify-content:center; gap:20px; margin-bottom:30px; flex-wrap:wrap;}
.card {flex:1 1 200px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.2); text-align:center; transition:0.3s;}
.card h2 {margin:0; font-size:2em; color:#fff;}
.card p {margin-top:5px; font-weight:bold; color:#333;}
.card.conectados {background: linear-gradient(135deg, #43e97b, #38f9d7);}
.card.desconectados {background: linear-gradient(135deg, #ff6a6a, #ffbaba);}

/* Table styles */
table {width:100%; border-collapse:collapse; margin-top:20px;}
th, td {padding:10px; border:1px solid #ddd; text-align:left;}
th {background:#2575fc; color:#fff;}
tr:nth-child(even) {background:#f9f9f9;}
</style>
</head>
<body>

<h1>Dashboard Admin - Portal Wi-Fi</h1>

<!-- Tela de Login -->
<div id="loginBox">
  <h2>Acesso Restrito</h2>
  <input type="password" id="senhaInput" placeholder="Digite a senha de admin">
  <button onclick="verificarSenha()">Entrar</button>
  <div id="error"></div>
</div>

<!-- Painel (inicialmente oculto) -->
<div id="painel" style="display:none;">
  <div class="cards">
    <div class="card conectados">
        <h2 id="conectados">0</h2>
        <p>Usu치rios Conectados</p>
    </div>
    <div class="card desconectados">
        <h2 id="desconectados">0</h2>
        <p>Usu치rios Desconectados</p>
    </div>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>CPF</th>
        <th>Nome</th>
        <th>Email</th>
        <th>Data/Hora</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="exportarCSV()">游닌 Exportar CSV</button>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Senha do admin
const SENHA_ADMIN = "admin2025";

// Verifica senha
window.verificarSenha = function() {
    const senha = document.getElementById("senhaInput").value;
    const error = document.getElementById("error");
    if(senha === SENHA_ADMIN) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("painel").style.display = "block";
        carregarPainel();
    } else {
        error.textContent = "Senha incorreta!";
    }
}

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDH1B9NAXby6EzwLhsMYkZWnYFWeLpUk1A",
  authDomain: "wifi-clientes-acaa1.firebaseapp.com",
  databaseURL: "https://wifi-clientes-acaa1-default-rtdb.firebaseio.com",
  projectId: "wifi-clientes-acaa1",
  storageBucket: "wifi-clientes-acaa1.firebasestorage.app",
  messagingSenderId: "227783158496",
  appId: "1:227783158496:web:f5a722e590ce62cfd4fe85",
  measurementId: "G-DKQQ965CXP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Carregar painel
function carregarPainel() {
    const tabelaBody = document.querySelector("#tabela tbody");
    const conectadosEl = document.getElementById("conectados");
    const desconectadosEl = document.getElementById("desconectados");

    onValue(ref(db, 'usuarios'), (snapshot) => {
        tabelaBody.innerHTML = "";
        let conectados = 0;
        let desconectados = 0;
        const hoje = new Date().toISOString().slice(0,10);

        snapshot.forEach((child) => {
            const dados = child.val();
            const cpf = child.key;

            // Zera a senha se a data mudou
            if(dados.dataHora && !dados.dataHora.startsWith(hoje)) {
                update(ref(db, 'usuarios/' + cpf), { senha: "" });
                dados.senha = "";
            }

            // Contar status de usu치rios
            if(dados.senha && dados.senha !== "") conectados++;
            else desconectados++;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${cpf}</td>
                <td>${dados.nome || ""}</td>
                <td>${dados.email || ""}</td>
                <td>${dados.dataHora || ""}</td>
            `;
            tabelaBody.appendChild(tr);
        });

        conectadosEl.textContent = conectados;
        desconectadosEl.textContent = desconectados;
    });
}

// Exportar CSV (sem senha, com aspas para cada campo)
window.exportarCSV = function() {
    const linhas = document.querySelectorAll("#tabela tbody tr");
    let csv = '"CPF","Nome","Email","Data/Hora"\n'; // Cabe칞alho

    linhas.forEach(linha => {
        const cols = linha.querySelectorAll("td");
        let row = [];
        cols.forEach(td => {
            // Coloca cada valor entre aspas e escapa aspas internas
            let valor = td.textContent.replace(/"/g, '""');
            row.push(`"${valor}"`);
        });
        csv += row.join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cadastros_wifi.csv";
    a.click();
}
</script>
</body>
</html>
